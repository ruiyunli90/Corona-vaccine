---
title: "VaccineSIR-ageShift"
author: "Ruiyun Li"
date: "08/02/2021"
output:
  pdf_document:
    latex_engine: xelatex
  html_document: default
---

This is a R Markdown document attached to **Switching from one target vaccination group to another during the transition from virgin pandemic to endemicity**. authors: Ruiyun Li, Ottar N Bjornstad, Nils Chr. Stenseth

In this document, we will use a RAS model that integrates realistic age-structure of both demography and social mixing and plausible coverage, timing and efficacy of vaccine. We compare the gains achievable by adopting various vaccination strategies with the aim to guide *near-term* and *intermediate term* policies for COVID-19 vaccination rollout.

## Preparation

We will first prepare the datasets, including

* age pyramid
* age-specific # of contacts
* age-specific infection-fatality ratio (IFR)

We include 17 5-year age groups (i.e. 0-4, 5-9, …, 75-79, >80 years old). To illustrate we use the UK as example.

```{r message = FALSE, warning = FALSE}
require("fields")
wd <- getwd()
Cont_path <- file.path(wd, "Data", "Contact_matrices")
Demo_path <- file.path(wd,"Data","Demography")
IFR_path <- file.path(wd,"Data","IFR")

# read contact matrix, marginal contacts, demography, IFR
W_UK <- read.csv(paste0(Cont_path,"/", "Contacts_UK.csv"), header = TRUE)[,2:18]
Cmarg_UK <- read.csv(paste0(Cont_path,"/", "margContacts_UK.csv"), header = TRUE)[,2]
Page_UK <- read.csv(paste0(Demo_path, "/", "Pop_UK.csv"), header = TRUE)[,2]

IFR <- read.csv(paste0(IFR_path, "/", "IFR_age_5yrs.csv"))[,2]

```

## Model Framework

The model involves coverage, timing and efficacy of vaccine. We define:

* S - Susceptble
* E - Exposed
* I - Infected
* R  - Recovered
* K - Flux into E

- $Q$ - rate of vaccination
− $P$ - duration of vaccination
- $q$ - vaccine efficacy
- *R0* - Reproduction number
- 1/$\sigma$ - Average duration of incubation
- 1/$\gamma$ - Average duration of infection
- $\omega$ - Rate of loss of infection
- *C* - Normalized contact matrix
- n   - Number of age groups

```{r}
seirsvages = function(t,x,params){
  n=17
  S<-x[1:n]
  E<-x[(n+1):(2*n)]
  I<-x[(2*n+1):(3*n)]
  R<-x[(3*n+1):(4*n)]
  K<-x[(4*n+1):(5*n)]
  
  with(as.list(params),{
    W = as.matrix(Cnorm)
    WI = W%*%I
    
    phi = R0*((sigma+mu)/sigma)*(gamma+mu) *WI/N
    
    Q <- if(t<Tvacend){
      ifelse((t%%repeat_Interval)<T | (t%%repeat_Interval)>T+Dt,0,(-log(1-P)/Dt))
      }else{
        0
        }
      
    dS = c(nu,rep(0,n-1))*N + omega*R -phi*S - q*Q*S - mu*S
    dE = phi*S - sigma*E - mu*E
    dI = sigma*E - gamma*I - mu*I
    dR = gamma*I + q*Q*S - omega*R - mu*R
    dK = sigma*E
    
    res<-c(dS,dE,dI,dR,dK)
    list(res)
  })
}

```

Model is initialized with 0.1% infected individuals. We define function for simulation:
```{r}
seirsvagessim = function(R0, P_age, W, q, P, T, Dt, durIm, Tvacend, repeat_Interval)
{
  pars = list(N = 1, sigma=1/5.2, gamma = 1/7, nu = 0, mu = 0, R0 = R0, Cnorm = W,
              omega=1/durIm, q = q, P = P, Dt = Dt, T = T, 
              Tvacend = Tvacend, repeat_Interval = repeat_Interval)
  ystart = c(S=.999*P_age,E=0*P_age,I=.001*P_age,R=0*P_age,K=0*P_age)
  out = as.data.frame(ode(ystart, times=times, func = seirsvages, parms = pars))
  
  return(out)
}

```

We consider four vaccination strategies:

* Strategies with single focus groups:

      (i-a) the elderly
  
      (i-b) the most socially mixing ones; 
  
* Strategies with two focus groups:

      (ii-a) mixed vaccination of two target groups simultaneously
  
      (ii-b) cyclic vaccination switching between groups.

We now define function for the four strategies:
```{r}
# (i-a) the elderly only #
elderly = function(P_age, tot_coverage)
{
  elderly = 14:17
  elderly_coverage = ifelse(sum(P_age[elderly])<tot_coverage, 
                            .90, tot_coverage/(sum(P_age[elderly])))
  
  P = rev(c(rep(elderly_coverage,4),rep(0,13)))
  T = rev(c(rep(1,4),rep(0,13)))
  Dt = rev(c(rep(90,4),rep(0,13)))
  
  return(list(P=P, T=T, Dt=Dt))
}

# (i-b) the most sociable only #
sociable = function(P_age, Cmarg, tot_coverage)
{
  sociable = order(Cmarg, decreasing = TRUE)[1:4]
  if(tot_coverage < sum(P_age[sociable])){
    sociable_coverage = tot_coverage/(sum(P_age[sociable]))
  }else{
    sociable_coverage = .90
  }
    
  P = T = Dt = rep(0, 17)
  P[sociable] = sociable_coverage
  T[sociable] = 1
  Dt[sociable] = 90
  
  return(list(P=P, T=T, Dt=Dt))
}

# (ii-a) mixed vaccination:
#        elderly and sociable simutaneously #
mixed2 = function(P_age, Cmarg, tot_coverage)
{
  elderly = 14:17
  sociable = order(Cmarg, decreasing = TRUE)[1:4]
  if((0.5*tot_coverage) < (sum(P_age[elderly]))){ # half dose to elderly
    elderly_coverage = 0.5*tot_coverage/(sum(P_age[elderly])) 
  }else{
    elderly_coverage = .90
  }
  if((0.5*tot_coverage) < (sum(P_age[sociable]))){ # half dose to sociable
    sociable_coverage = 0.5*tot_coverage/(sum(P_age[sociable])) 
  }else{
    sociable_coverage = .90
  }

  P = T = Dt = rep(0, 17)
  P[elderly] = elderly_coverage; P[sociable] = sociable_coverage
  T[elderly] = 1; T[sociable] = 1
  Dt[elderly] = 90; Dt[sociable] = 90
  
  return(list(P=P, T=T, Dt=Dt))
}

# (ii-b) Cyclic vaccination:
#        switch from elderly to sociable #
switch2 = function(P_age, Cmarg, tot_coverage)
{
  elderly = 14:17
  sociable = order(Cmarg, decreasing = TRUE)[1:4]
  if((0.5*tot_coverage) < (sum(P_age[elderly]))){ # half dose to elderly
    elderly_coverage = 0.5*tot_coverage/(sum(P_age[elderly])) 
  }else{
    elderly_coverage = .90
  }
  if((0.5*tot_coverage) < (sum(P_age[sociable]))){ # half dose to sociable
    sociable_coverage = 0.5*tot_coverage/(sum(P_age[sociable])) 
  }else{
    sociable_coverage = .90
  }  
  P = T = Dt = rep(0, 17)
  P[elderly] = elderly_coverage; P[sociable] = sociable_coverage
  T[elderly] = 1; T[sociable] = 1+45
  Dt[elderly] = 45; Dt[sociable] = 45
  
  return(list(P=P, T=T, Dt=Dt))
}

```

Together with four vaccination strategie we also consider three frequencies of (re)vaccination:

* One-off
* repeat every year
* repeat every half year

We now define functions to apply vaccine strategies to various scenarios, including varying:

- R0: e.g. 1.5 (low), 2 (medium), 3 (high)
- Immunity duration ($durIm$): e.g. 6mos (183days), 1year (365), 5year (365*5)
- Vaccine efficacy ($VE$): e.g. 0.2 (low), 0.5 (medium), 0.8 (high)
- Country-specific demography ($P_age$), contact matrix ($W$) and margninal # of contacts ($Cmarg$)
- Total vaccine dose ($tot_coverage$): e.g. 0.5, 0.4

```{r}
# baseline i.e. no vaccination #
sim_baseline = function(R0, durIm, P_age, W)
{
  out = seirsvagessim(R0=R0, P_age=P_age, W=W, durIm=durIm,
                      q=0,P=c(rep(0,n)), T=c(rep(0,n)), Dt=c(rep(0,n)),
                      Tvacend=0,repeat_Interval=365*20)
  return(out)
}

# 4 Strategies (S1-S4) once only (F1) #
sim_F1.S1 = function(R0, durIm, VE, tot_coverage, P_age, W, Cmarg)
{
  out = seirsvagessim(R0=R0, P_age=P_age, W=W, durIm=durIm,
                      q=VE,P=elderly(P_age,tot_coverage)$P, 
                      T=elderly(P_age,tot_coverage)$T, 
                      Dt=elderly(P_age,tot_coverage)$Dt,
                      Tvacend=365, repeat_Interval = 365*20)
  return(out)
}
sim_F1.S2 = function(R0, durIm, VE, tot_coverage, P_age, W, Cmarg)
{
  out = seirsvagessim(R0=R0, P_age=P_age, W=W, durIm=durIm,
                      q=VE,P=sociable(P_age,Cmarg,tot_coverage)$P, 
                      T=sociable(P_age,Cmarg,tot_coverage)$T, 
                      Dt=sociable(P_age,Cmarg,tot_coverage)$Dt,
                      Tvacend=365, repeat_Interval = 365*20)
  return(out)
}
sim_F1.S3 = function(R0, durIm, VE, tot_coverage, P_age, W, Cmarg)
{
  out = seirsvagessim(R0=R0, P_age=P_age, W=W, durIm=durIm,
                      q=VE,P=mixed2(P_age,Cmarg,tot_coverage)$P, 
                      T=mixed2(P_age,Cmarg,tot_coverage)$T, 
                      Dt=mixed2(P_age,Cmarg,tot_coverage)$Dt,
                      Tvacend=365, repeat_Interval = 365*20)
  return(out)
}
sim_F1.S4 = function(R0, durIm, VE, tot_coverage, P_age, W, Cmarg)
{
  out = seirsvagessim(R0=R0, P_age=P_age, W=W, durIm=durIm,
                      q=VE,P=switch2(P_age,Cmarg,tot_coverage)$P, 
                      T=switch2(P_age,Cmarg,tot_coverage)$T, 
                      Dt=switch2(P_age,Cmarg,tot_coverage)$Dt,
                      Tvacend=365, repeat_Interval = 365*20)
  return(out)
}

# Repeat 4 Strategies (S1-S4) annually (F2) #
sim_F2.S1 = function(R0, durIm, VE, tot_coverage, P_age, W, Cmarg)
{
  out = seirsvagessim(R0=R0, P_age=P_age, W=W, durIm=durIm,
                      q=VE,P=elderly(P_age,tot_coverage)$P, 
                      T=elderly(P_age,tot_coverage)$T, 
                      Dt=elderly(P_age,tot_coverage)$Dt,
                      Tvacend=365*20, repeat_Interval = 365)
  return(out)
}
sim_F2.S2 = function(R0, durIm, VE, tot_coverage, P_age, W, Cmarg)
{
  out = seirsvagessim(R0=R0, P_age=P_age, W=W, durIm=durIm,
                      q=VE,P=sociable(P_age,Cmarg,tot_coverage)$P, 
                      T=sociable(P_age,Cmarg,tot_coverage)$T, 
                      Dt=sociable(P_age,Cmarg,tot_coverage)$Dt,
                      Tvacend=365*20, repeat_Interval = 365)
  return(out)
}
sim_F2.S3 = function(R0, durIm, VE, tot_coverage, P_age, W, Cmarg)
{
  out = seirsvagessim(R0=R0, P_age=P_age, W=W, durIm=durIm,
                      q=VE,P=mixed2(P_age,Cmarg,tot_coverage)$P, 
                      T=mixed2(P_age,Cmarg,tot_coverage)$T, 
                      Dt=mixed2(P_age,Cmarg,tot_coverage)$Dt,
                      Tvacend=365*20, repeat_Interval = 365)
  return(out)
}
sim_F2.S4 = function(R0, durIm, VE, tot_coverage, P_age, W, Cmarg)
{
  out = seirsvagessim(R0=R0, P_age=P_age, W=W, durIm=durIm,
                      q=VE,P=switch2(P_age,Cmarg,tot_coverage)$P, 
                      T=switch2(P_age,Cmarg,tot_coverage)$T, 
                      Dt=switch2(P_age,Cmarg,tot_coverage)$Dt,
                      Tvacend=365*20, repeat_Interval = 365)
  return(out)
}

# Repeat 4 Strategies (S1-S4) every half year (F3) #
sim_F3.S1 = function(R0, durIm, VE, tot_coverage, P_age, W, Cmarg)
{
  out = seirsvagessim(R0=R0, P_age=P_age, W=W, durIm=durIm,
                      q=VE,P=elderly(P_age,tot_coverage)$P, 
                      T=elderly(P_age,tot_coverage)$T, 
                      Dt=elderly(P_age,tot_coverage)$Dt,
                      Tvacend=365*20, repeat_Interval = 182)
  return(out)
}
sim_F3.S2 = function(R0, durIm, VE, tot_coverage, P_age, W, Cmarg)
{
  out = seirsvagessim(R0=R0, P_age=P_age, W=W, durIm=durIm,
                      q=VE,P=sociable(P_age,Cmarg,tot_coverage)$P, 
                      T=sociable(P_age,Cmarg,tot_coverage)$T, 
                      Dt=sociable(P_age,Cmarg,tot_coverage)$Dt,
                      Tvacend=365*20, repeat_Interval = 182)
  return(out)
}
sim_F3.S3 = function(R0, durIm, VE, tot_coverage, P_age, W, Cmarg)
{
  out = seirsvagessim(R0=R0, P_age=P_age, W=W, durIm=durIm,
                      q=VE,P=mixed2(P_age,Cmarg,tot_coverage)$P, 
                      T=mixed2(P_age,Cmarg,tot_coverage)$T, 
                      Dt=mixed2(P_age,Cmarg,tot_coverage)$Dt,
                      Tvacend=365*20, repeat_Interval = 182)
  return(out)
}
sim_F3.S4 = function(R0, durIm, VE, tot_coverage, P_age, W, Cmarg)
{
  out = seirsvagessim(R0=R0, P_age=P_age, W=W, durIm=durIm,
                      q=VE,P=switch2(P_age,Cmarg,tot_coverage)$P, 
                      T=switch2(P_age,Cmarg,tot_coverage)$T, 
                      Dt=switch2(P_age,Cmarg,tot_coverage)$Dt,
                      Tvacend=365*20, repeat_Interval = 182)
  return(out)
}

```


We now simulate the model (featuring UK), assuming a total vaccine allotment capable of covering 50% of the population, 1-year immunity duration ($durIm$ = 365), high vaccine efficacy ($VE$ = 80%) and low transmission intensity (R0 = 1.5).
```{r}
library(deSolve)
n = 17 # 17 age groups
x = 1:100 # assuming a life-expectancy of 100yrs
times = 1:(365*20) # simulate the model for 20 years

UK_baseline = sim_baseline(1.5, 365, Page_UK, W_UK)

UK_F1.S1 = sim_F1.S1(1.5, 365, .8, .5, Page_UK, W_UK, Cmarg_UK)
UK_F1.S2 = sim_F1.S2(1.5, 365, .8, .5, Page_UK, W_UK, Cmarg_UK)
UK_F1.S3 = sim_F1.S3(1.5, 365, .8, .5, Page_UK, W_UK, Cmarg_UK)
UK_F1.S4 = sim_F1.S4(1.5, 365, .8, .5, Page_UK, W_UK, Cmarg_UK)

UK_F2.S1 = sim_F2.S1(1.5, 365, .8, .5, Page_UK, W_UK, Cmarg_UK)
UK_F2.S2 = sim_F2.S2(1.5, 365, .8, .5, Page_UK, W_UK, Cmarg_UK)
UK_F2.S3 = sim_F2.S3(1.5, 365, .8, .5, Page_UK, W_UK, Cmarg_UK)
UK_F2.S4 = sim_F2.S4(1.5, 365, .8, .5, Page_UK, W_UK, Cmarg_UK)

UK_F3.S1 = sim_F3.S1(1.5, 365, .8, .5, Page_UK, W_UK, Cmarg_UK)
UK_F3.S2 = sim_F3.S2(1.5, 365, .8, .5, Page_UK, W_UK, Cmarg_UK)
UK_F3.S3 = sim_F3.S3(1.5, 365, .8, .5, Page_UK, W_UK, Cmarg_UK)
UK_F3.S4 = sim_F3.S4(1.5, 365, .8, .5, Page_UK, W_UK, Cmarg_UK)

```

We now estimate the age-specific infections and mortality for each of the scenario:
```{r}
Infages_baseline = UK_baseline[,(2*n+2):(3*n+1)]
Infages_F1.S1 = UK_F1.S1[,(2*n+2):(3*n+1)]
Infages_F1.S2 = UK_F1.S2[,(2*n+2):(3*n+1)]
Infages_F1.S3 = UK_F1.S3[,(2*n+2):(3*n+1)]
Infages_F1.S4 = UK_F1.S4[,(2*n+2):(3*n+1)]
Infages_F2.S1 = UK_F1.S1[,(2*n+2):(3*n+1)]
Infages_F2.S2 = UK_F1.S2[,(2*n+2):(3*n+1)]
Infages_F2.S3 = UK_F1.S3[,(2*n+2):(3*n+1)]
Infages_F2.S4 = UK_F1.S4[,(2*n+2):(3*n+1)]
Infages_F3.S1 = UK_F1.S1[,(2*n+2):(3*n+1)]
Infages_F3.S2 = UK_F1.S2[,(2*n+2):(3*n+1)]
Infages_F3.S3 = UK_F1.S3[,(2*n+2):(3*n+1)]
Infages_F3.S4 = UK_F1.S4[,(2*n+2):(3*n+1)]

Inf2Dages_baseline = Inf2Dages_F1.S1 = Inf2Dages_F1.S2 = Inf2Dages_F1.S3 = Inf2Dages_F1.S4 = 
  Inf2Dages_F2.S1 = Inf2Dages_F2.S2 = Inf2Dages_F2.S3 = Inf2Dages_F2.S4 = 
  Inf2Dages_F3.S1 = Inf2Dages_F3.S2 = Inf2Dages_F3.S3 = Inf2Dages_F3.S4 = 
  matrix(NA, nrow=365*20, ncol=n)
for(i in 1:n){
  Inf2Dages_baseline[,i] = Infages_baseline[,i] * IFR[i]
  Inf2Dages_F1.S1[,i] = Infages_F1.S1[,i] * IFR[i]
  Inf2Dages_F1.S2[,i] = Infages_F1.S2[,i] * IFR[i]
  Inf2Dages_F1.S3[,i] = Infages_F1.S3[,i] * IFR[i]
  Inf2Dages_F1.S4[,i] = Infages_F1.S4[,i] * IFR[i]
  Inf2Dages_F2.S1[,i] = Infages_F2.S1[,i] * IFR[i]
  Inf2Dages_F2.S2[,i] = Infages_F2.S2[,i] * IFR[i]
  Inf2Dages_F2.S3[,i] = Infages_F2.S3[,i] * IFR[i]
  Inf2Dages_F2.S4[,i] = Infages_F2.S4[,i] * IFR[i]
  Inf2Dages_F3.S1[,i] = Infages_F3.S1[,i] * IFR[i]
  Inf2Dages_F3.S2[,i] = Infages_F3.S2[,i] * IFR[i]
  Inf2Dages_F3.S3[,i] = Infages_F3.S3[,i] * IFR[i]
  Inf2Dages_F3.S4[,i] = Infages_F3.S4[,i] * IFR[i]
}

```

so the overall infections and mortality averted as compared with baseline in:

- the short term: i) the first six month, ii) the 1st and iii) the 2nd year 
- the long term: iv) the 5th, ii) the 10th and iii) the 20th year 

is defined as:

```{r}
Inf_avert = function(sim_base, sim)
{
  out = (apply(sim_base[,(4*n+2):(5*n+1)],1,sum)-apply(sim[,(4*n+2):(5*n+1)],1,sum))/
    apply(sim_base[,(4*n+2):(5*n+1)],1,sum)*100
  
  return(c(out[183], out[365], out[365*2], 
           out[365*5], out[365*10], out[365*20]))
}

Inf2D_avert = function(Inf2D_base, Inf2D)
{
  yr.5 = sum(apply(Inf2D_base-Inf2D,1,sum)[1:183])/
    sum(apply(Inf2D_base,1,sum)[1:183])*100
  yr1 = sum(apply(Inf2D_base-Inf2D,1,sum)[1:365])/
    sum(apply(Inf2D_base,1,sum)[1:365])*100
  yr2 = sum(apply(Inf2D_base-Inf2D,1,sum)[1:(365*2)])/
    sum(apply(Inf2D_base,1,sum)[1:(365*2)])*100
  yr5 = sum(apply(Inf2D_base-Inf2D,1,sum)[1:(365*5)])/
    sum(apply(Inf2D_base,1,sum)[1:(365*5)])*100
  yr10 = sum(apply(Inf2D_base-Inf2D,1,sum)[1:(365*10)])/
    sum(apply(Inf2D_base,1,sum)[1:(365*10)])*100
  yr20 = sum(apply(Inf2D_base-Inf2D,1,sum))/
    sum(apply(Inf2D_base,1,sum))*100
  
  return(c(yr.5,yr1,yr2,yr5,yr10,yr20))
}

Inf_avert_F1.S1 = Inf_avert(UK_baseline, UK_F1.S1)
Inf2D_avert_F1.S1 = Inf2D_avert(Inf2Dages_baseline, Inf2Dages_F1.S1)
```

For other scenarios, following the simulations aforementioned by replacing parameter values accordingly.


